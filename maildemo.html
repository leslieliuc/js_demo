<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>視覺判斷實驗</title>
    <script src="https://unpkg.com/jspsych@8.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
      body {
        background-color: black;
        color: white;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      window.onload = function() {
        emailjs.init("8Td-18iLwoI-zL7iZ");
      };

      var jsPsych = initJsPsych({
        on_finish: function() {
          var subject_code = jsPsych.data.get().last(1).values()[0]?.subject_code || "unknown"; 
          var allData = jsPsych.data.get().filter({ task: 'response' }).trials.map(trial => {
            return {
              Subject: subject_code,
              Stimulus1: trial.stimulus1,
              Stimulus2: trial.stimulus2,
              CorrectResponse: trial.correct_response,
              Response: trial.response || "NA",
              Correction: trial.correct ? 1 : 0,
              RT: trial.rt,
              FixationTime: 1000, 
              TimeElapsed: trial.time_elapsed
            };
          });
        
          var correctAnswers = jsPsych.data.get().filter({ task: 'response' }).trials.filter(trial => trial.correct).length;
          var totalStimuli = jsPsych.data.get().filter({ task: 'response' }).trials.length;
          var accuracy = correctAnswers/totalStimuli*100;
          
          // Add accuracy to data
          var accuracyRow = {
            Subject: subject_code,
            Stimulus1: "",
            Stimulus2: "",
            CorrectResponse: "",
            Response: "",
            Correction: "",
            RT: "",
            FixationTime: "",
            TimeElapsed: "",
            Accuracy: accuracy.toFixed(2)
          };
          allData.push(accuracyRow);
          
          // Create Excel file
          var ws = XLSX.utils.json_to_sheet(allData);
          var wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Experiment Data");

          // Generate file and send email
          var excelFile = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
          var blob = new Blob([s2ab(excelFile)], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
          function s2ab(s) {
            var buf = new ArrayBuffer(s.length);
            var view = new Uint8Array(buf);
            for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xff;
            return buf;
          }
          // Convert to Blob URL and send email
          var emailData = {
            to_email: "brain.learning.lab@gmail.com",
            subject_code: subject_code,
            accuracy: accuracy
          };

          emailjs.send("service_ycdyoaf", "template_dz66or8", emailData).then(
            (response) => console.log("Experimenter Email Sent!", response),
            (error) => console.log("Failed to send email to experimenter", error)
          );
          
          var email = jsPsych.data.get().last(1).values()[0]?.subject_email || "";
          if (email) {
            emailData.to_email = email;
            console.log("Sending email to participant...");
            emailjs.send("service_ycdyoaf", "template_dz66or8", emailData).then(
              (response) => console.log("Participant Email Sent!", response),
              (error) => console.log("Failed to send email to participant", error)
            );
          }

          var a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = subject_code + "_experiment_data.xlsx";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          var timeline = [];

          // 同意書頁面
          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: ` 
              <div style="text-align: justify;">
                <p>感謝你參加本次實驗，以下是實驗相關內容與同意參加確認。</p>
                <p>實驗目的:字形相異判斷與反應時間</p>
                <p>研究方法與程序:閱讀本頁面後，你會進入練習的部分，此部分主要是讓你熟悉實驗中會用到的反應按鍵，預計有五題。</p>
                <p>以及你所需要的操作。接著便是正式實驗，時間約為30分鐘。</p>
                <p>招募對象及條件:大學生</p>
                <p>實驗副作用:實驗不會帶來任何副作用</p>
                <p>實驗資料保存及運用:電子檔案將保留在實驗室硬碟中，實驗資料都會刪除可辨識您個本人的個資後會發布。</p>
                <p>實驗退出及中止:你可以隨時撤銷同意或中止實驗，當你決定退出時，可與本實驗室聯繫，實驗室會協助刪除你的資料。</p>
                <p>本實驗由國立台灣師範大學李俊仁老師實驗室發布</p>
                <p>若你理解、同意上述事項且同意參加，請於下一頁輸入你的姓名及今日日期當作受試者同意書。</p>
                <p>按任意鍵繼續下頁</p>
              </div>
            `,
            post_trial_gap: 1000
          });

          // 同意書署名及日期
          var agreement = {
            type: jsPsychSurveyHtmlForm,
            preamble: '<p>請輸入你的姓名以及今日日期</p>',
            html: '<p>本人<input name="first" type="text" />已看完上頁內容,於 <input name="second" type="text" />同意參加本實驗。</p>',
            autofocus: 'agreement',
            on_finish: function(data) {
              jsPsych.data.addProperties({
                subject_name: data.response.first,
                subject_date: data.response.second
              });
            }
          };
          timeline.push(agreement);

          // 輸入受試者編碼頁面
          var code_entry = {
            type: jsPsychSurveyHtmlForm,
            preamble: '<p>請輸入您收到的受試者編碼(ID)：</p>',
            html: '<p>ID: <input type="text" id="subject-code" name="subject_code" size="10" /></p>',
            autofocus: 'code_entry',
            on_finish: function(data) {
              jsPsych.data.addProperties({ subject_code: data.response.subject_code });
            }
          };
          timeline.push(code_entry);

          // 輸入電子信箱
          var mail_entry = {
            type: jsPsychSurveyHtmlForm,
            preamble: '<p>請輸入你的電子信箱以利後續連繫：</p>',
            html: '<p>mail: <input type="text" id="participant-email" name="participant_email"/></p>',
            autofocus: 'mail_entry',
            on_finish: function(data) {
              jsPsych.data.addProperties({ subject_email: data.response["participant-email"] });
            }
          };
          timeline.push(mail_entry);

          // 說明頁面
          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: ` 
              <p>螢幕上，會出現兩個韓文字母</p>
              <p>如果字母<strong>相同</strong>，請按 Z 鍵</p>
              <p>如果字母<strong>不同</strong>，請按 / 鍵</p>
              <p>按任意鍵繼續</p>
            `,
            post_trial_gap: 1000
          });

          // 凝視點
          var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: "NO_KEYS",
            trial_duration: 1000,
            data: { task: 'fixation' }
          };

          // 刺激
          var stimulus1 = ["앗", "다", "바", "갸", "에", "옝", "분", "와", "숰", "송"];
          var stimulus2 = ["맛", "다", "사", "교", "에", "옝", "본", "와", "숰", "솝"];
          var correct_responses = ["/", "Z", "/", "/", "Z", "Z", "Z", "Z", "/", "Z", "/"];

          var stimuli = stimulus1.map((s1, i) => ({

            stimulus1: s1,
            stimulus2: stimulus2[i],
            correct_response: correct_responses[i]
          }));

          // 實驗
          var test = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
              var stim1 = jsPsych.evaluateTimelineVariable('stimulus1');
              var stim2 = jsPsych.evaluateTimelineVariable('stimulus2');
              return `<div style="display: flex; justify-content: center; font-size: 60px;">
                        <p style="margin-right: 50px;">${stim1}</p>
                        <p style="margin-left: 50px;">${stim2}</p>
                      </div>`;
            },
            choices: ['Z', '/'],
            data: function() {
              return {
                task: 'response',
                stimulus1: jsPsych.evaluateTimelineVariable('stimulus1'),
                stimulus2: jsPsych.evaluateTimelineVariable('stimulus2'),
                correct_response: jsPsych.evaluateTimelineVariable('correct_response')
              };
            },
            on_finish: function(data) {
              data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
            }
          };

          // 實驗程序
          var test_procedure = {
            timeline: [fixation, test],
            timeline_variables: stimuli,
            repetitions: 1,
            randomize_order: true
          };
          timeline.push(test_procedure);

          // 確認電子信箱
          var email_confirmation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
              var emailData = jsPsych.data.get().values().find(d => d.subject_email) || {};
              var email = emailData.subject_email || "未輸入";
              return `<div style="text-align: center;">
                        <p>您輸入的電子信箱是: <strong>${email}</strong></p>
                        <p>確認無誤，請按 1，若需修改，請按 2。</p>
                      </div>`;
            },
            choices: ['1', '2'],
            on_finish: function(data) {
              if (data.response == '1') {
                var emailData = jsPsych.data.get().values().find(d => d.subject_email);
                var email = emailData ? emailData.subject_email : "";
                sendEmail(email);
              } else {
                jsPsych.data.addProperties({ subject_email: data.response.participant_email });
                jsPsych.addNodeToEnd({ timeline: [email_entry] });
                jsPsych.run();
              }
            }
          };
          timeline.push(email_confirmation);

          // 重新輸入電子信箱頁面
          var email_entry = {
            type: jsPsychSurveyHtmlForm,
            preamble: '<p>請再次輸入您的電子信箱：</p>',
            html: '<p>mail: <input name="subject_email" type="text" size="10" /></p>',
            on_finish: function(data) {
              jsPsych.data.addProperties({ subject_email: data.response.subject_email });
            }
          };

          // 結束頁面
          timeline.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<p>按任意鍵結束實驗，感謝您的參與！</p>'
          });

          jsPsych.run(timeline);
        }
      });
    </script>
  </body>
</html>
